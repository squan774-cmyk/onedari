<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>おねだりパワハラゲーム</title>
  <style>
    :root {
      --bg: #f7f6f3;
      --card: #ffffff;
      --accent: #c0392b;
      --ok: #d35400;
      --ng: #2c3e50;
      --text: #222;
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: linear-gradient(180deg, var(--bg), #efece7);
      color: var(--text);
    }
    .wrap { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
    .stage {
      width: 100%; max-width: 920px; background: var(--card);
      border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      padding: 18px; box-sizing: border-box; position: relative;
    }
    .title { display:flex; flex-direction:column; gap:12px; align-items:center; text-align:center; padding:20px; }
    .title h1 { margin:0; font-size:clamp(28px,6vw,44px); letter-spacing:1px; }
    .desc { white-space:pre-line; color:#333; max-width:820px }
    .controls { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:8px }
    .btn { background:#111; color:#fff; padding:10px 16px; border-radius:10px; border:none; font-weight:700; cursor:pointer; }
    .difficulty { display:flex; gap:8px; flex-direction:column; align-items:center }
    .diff-list { display:flex; gap:8px }
    .diff-item { background:#f0f0f0; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .diff-item.selected { background:var(--accent); color:#fff }
    .game-area { display:none; flex-direction:column; gap:12px }
    .topbar { display:flex; justify-content:space-between; align-items:center }
    .counter { font-weight:700 }

    /* タイマーバー */
    .timer-bar {
      height: 12px;
      background: repeating-linear-gradient(
        to right,
        #ddd 0,
        #ddd calc(10% - 1px),
        #bbb calc(10% - 1px),
        #bbb 10%
      );
      border-radius: 6px;
      overflow: hidden;
      flex: 1;
      margin-left: 12px;
      position: relative;
    }
    .timer-fill {
      height: 100%;
      width: 100%;
      transform-origin: left;
      background: linear-gradient(90deg, #f39c12, #e74c3c);
      position: absolute;
      top: 0;
      left: 0;
    }
    .timer-label { font-weight: bold; font-size: 14px; margin-left: 8px; min-width: 40px; text-align: right; }

    .playfield { display:flex; flex-direction:column; gap:14px }
    .icons-grid { display:grid; grid-template-columns:repeat(5,1fr); gap:12px; padding:12px }
    .icon-slot { background:transparent; border-radius:10px; display:flex; align-items:center; justify-content:center; padding:6px; position:relative; }
    .icon-slot img { width:64px; height:64px; object-fit:contain; user-select:none }
    .overlay-mark { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:48px; pointer-events:none; }
    .overlay-mark.ok { color:var(--ok); }
    .overlay-mark.ng { color:#1976d2 }

    .bottom-characters { display:flex; justify-content:space-between; align-items:flex-end; padding:6px; }
    .character { width:96px; height:96px }
    .countdown-overlay {
      position:absolute; inset:0; background:rgba(0,0,0,0.45);
      display:flex; align-items:center; justify-content:center;
      color:#fff; font-size:72px; font-weight:900; z-index:40;
    }
    .hidden { display:none }
    .result-screen { display:none; flex-direction:column; gap:12px; align-items:center; padding:20px }
    .footer-btn { margin-top:12px }
    .muted { font-size:13px; color:#666 }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="stage">
      <!-- TITLE -->
      <div id="titleScreen" class="title">
        <h1>おねだりパワハラゲーム</h1>
        <div class="desc">元彦がおねだりした物を急いで献上しよう！
間違えたり制限時間を過ぎるとパワハラされるぞ！
問題は全部で10問、目指せ全問正解！</div>
        <div class="controls">
          <div class="difficulty">
            <div class="muted">難易度</div>
            <div class="diff-list">
              <button class="diff-item" data-diff="0" id="diff-kencho">県庁</button>
              <button class="diff-item selected" data-diff="1" id="diff-normal">普通</button>
              <button class="diff-item" data-diff="2" id="diff-easy">易しい</button>
            </div>
          </div>
          <button class="btn" id="startBtn">ゲーム開始</button>
        </div>
      </div>

      <!-- GAME -->
      <div id="gameScreen" class="game-area">
        <div class="topbar">
          <div class="counter">第 <span id="qIndex">0</span> / 10</div>
          <div style="display:flex;align-items:center;flex:1;margin-left:12px">
            <div class="timer-bar">
              <div id="timerFill" class="timer-fill"></div>
            </div>
            <div id="timerLabel" class="timer-label">0.0s</div>
            <div style="width:12px"></div>
            <div id="score" style="font-weight:700">正解: 0</div>
          </div>
        </div>

        <div class="playfield">
          <div id="questionArea" style="text-align:center;font-weight:700;font-size:20px;">
            <div>元彦のおねだり品：</div>
            <img id="wantedIcon" src="" alt="wanted" style="width:80px;height:80px;margin-top:6px;object-fit:contain;">
            <div id="wantedLabel" style="margin-top:6px;font-size:18px;"></div>
          </div>
          <div class="icons-grid" id="iconsGrid"></div>
        </div>

        <div class="bottom-characters">
          <img id="playerImg" src="player.png" alt="player" class="character" />
          <img id="hikoImg" src="hiko.png" alt="hiko" class="character" />
        </div>
      </div>

      <!-- COUNTDOWN -->
      <div id="countdown" class="countdown-overlay hidden">3</div>

      <!-- RESULT -->
      <div id="resultScreen" class="result-screen">
        <h2 id="resultTitle">結果</h2>
        <div id="resultText" style="white-space:pre-line"></div>
        <div id="resultScore" style="font-weight:900;font-size:22px"></div>
        <button class="btn footer-btn" id="toTitleBtn">タイトルに戻る</button>
      </div>
    </div>
  </div>

  <script>
    const ICONS = [
      {id:'wine', label:'ワイン', src:'wine.png'},
      {id:'kani', label:'香住ガニ', src:'kani.png'},
      {id:'kaki', label:'カキ', src:'kaki.png'},
      {id:'yunomi', label:'湯呑み', src:'yunomi.png'},
      {id:'sake', label:'日本酒', src:'sake.png'},
      {id:'ski', label:'スキーウェア', src:'ski.png'},
      {id:'negi', label:'岩津ネギ', src:'negi.png'},
      {id:'wear', label:'スポーツウェア', src:'wear.png'},
      {id:'ichigo', label:'苺', src:'ichigo.png'},
      {id:'shio', label:'塩', src:'shio.png'}
    ];

    const SOUNDS = {
      bgm: new Audio('bgm.mp3'),
      don: new Audio('don.mp3'),
      pinpon: new Audio('pinpon.mp3'),
      ome: new Audio('ome.mp3')
    };
    SOUNDS.bgm.loop = true;

    const titleScreen = document.getElementById('titleScreen');
    const gameScreen = document.getElementById('gameScreen');
    const resultScreen = document.getElementById('resultScreen');
    const iconsGrid = document.getElementById('iconsGrid');
    const qIndexEl = document.getElementById('qIndex');
    const scoreEl = document.getElementById('score');
    const timerFill = document.getElementById('timerFill');
    const timerLabel = document.getElementById('timerLabel');
    const countdown = document.getElementById('countdown');
    const playerImg = document.getElementById('playerImg');
    const hikoImg = document.getElementById('hikoImg');
    const resultTitle = document.getElementById('resultTitle');
    const resultText = document.getElementById('resultText');
    const resultScore = document.getElementById('resultScore');
    const wantedLabel = document.getElementById('wantedLabel');

    let difficulty = 1;
    let times = [500,1500,2500]; // 県庁=0.5秒, 普通=1.5秒, 易しい=2.5秒
    let currentQ = 0;
    let correctCount = 0;
    let correctId = null;
    let questionTimer = null;

    document.querySelectorAll('.diff-item').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.diff-item').forEach(b=>b.classList.remove('selected'));
        btn.classList.add('selected');
        difficulty = Number(btn.dataset.diff);
      });
    });

    function buildGrid(){
      iconsGrid.innerHTML = '';
      ICONS.forEach(ic=>{
        const slot = document.createElement('div');
        slot.className = 'icon-slot';
        slot.dataset.id = ic.id;
        const img = document.createElement('img');
        img.src = ic.src;
        img.alt = ic.label;
        slot.appendChild(img);
        const mark = document.createElement('div');
        mark.className = 'overlay-mark hidden';
        slot.appendChild(mark);
        slot.addEventListener('click',()=>onPick(slot));
        iconsGrid.appendChild(slot);
      });
    }
    buildGrid();

    document.getElementById('startBtn').addEventListener('click',()=>{
      titleScreen.style.display='none';
      resultScreen.style.display='none';
      gameScreen.style.display='flex';
      startCountdownThenStartGame();
    });

    function startCountdownThenStartGame(){
      countdown.classList.remove('hidden');
      let nums = ['3','2','1'];
      let i=0;
      countdown.textContent = nums[i];
      const cd = setInterval(()=>{
        i++;
        if(i<nums.length) countdown.textContent = nums[i];
        else{ clearInterval(cd); countdown.textContent = 'START';
          setTimeout(()=>{ countdown.classList.add('hidden'); beginGame(); },200);
        }
      },1000);
    }

    function beginGame(){
      currentQ=0; correctCount=0;
      qIndexEl.textContent='0'; scoreEl.textContent='正解: 0';
      SOUNDS.bgm.currentTime=0;
      SOUNDS.bgm.play().catch(()=>{});
      nextQuestionWithDelay(0);
    }

    function nextQuestionWithDelay(delay=250){ setTimeout(()=>startQuestion(), delay); }

    function startQuestion(){
      currentQ++;
      qIndexEl.textContent=currentQ;
      const idx=Math.floor(Math.random()*ICONS.length);
      const wanted=ICONS[idx];
      correctId=wanted.id;
      document.getElementById("wantedIcon").src=wanted.src;
      document.getElementById("wantedIcon").alt=wanted.label;
      wantedLabel.textContent = wanted.label;

      document.querySelectorAll('.icon-slot .overlay-mark').forEach(m=>{ m.classList.add('hidden'); m.textContent=''; });

      const t=times[difficulty];
      // タイマーリセット
      timerFill.style.transition='none';
      timerFill.style.transform='scaleX(1)';
      void timerFill.offsetWidth;
      timerFill.style.transition=`transform ${t}ms linear`;
      timerFill.style.transform='scaleX(0)';

      const startTime=Date.now();
      clearInterval(window.timerInterval);
      window.timerInterval=setInterval(()=>{
        const elapsed=Date.now()-startTime;
        const remain=Math.max(0, t - elapsed);
        timerLabel.textContent=(remain/1000).toFixed(1)+'s';
        if(remain<=0){ clearInterval(window.timerInterval); timerLabel.textContent='0.0s'; }
      },50);

      clearTimeout(questionTimer);
      questionTimer=setTimeout(()=>{
        clearInterval(window.timerInterval);
        markWrong(null,true);
      },t);
    }

    function onPick(slot){
      if(currentQ===0 || currentQ>10) return;
      const mark=slot.querySelector('.overlay-mark');
      if(!mark.classList.contains('hidden')) return;
      clearTimeout(questionTimer);
      clearInterval(window.timerInterval);
      const picked=slot.dataset.id;
      if(picked===correctId) markInner(slot,true);
      else markInner(slot,false);
    }

    function markInner(slot,isOk){
      const mark=slot.querySelector('.overlay-mark');
      mark.classList.remove('hidden');
      if(isOk){
        mark.classList.add('ok'); mark.textContent='○';
        correctCount++; scoreEl.textContent='正解: '+correctCount;
        playerImg.src='player3.png'; hikoImg.src='hiko3.png'; playSound('pinpon');
      } else {
        mark.classList.add('ng'); mark.textContent='×';
        playerImg.src='player2.png'; hikoImg.src='hiko2.png'; playSound('don');
      }
      if(currentQ>=10){ setTimeout(()=>finishGame(),250); }
      else {
        setTimeout(()=>{
          playerImg.src='player.png'; hikoImg.src='hiko.png';
          nextQuestionWithDelay(250);
        },250);
      }
    }

    function markWrong(slot=null,byTimeout=false){
      playerImg.src='player2.png'; hikoImg.src='hiko2.png'; playSound('don');
      if(currentQ>=10){ setTimeout(()=>finishGame(),250); }
      else {
        setTimeout(()=>{
          playerImg.src='player.png'; hikoImg.src='hiko.png';
          nextQuestionWithDelay(250);
        },250);
      }
    }

    function finishGame(){
      try{ SOUNDS.bgm.pause(); }catch(e){}
      gameScreen.style.display='none';
      resultScreen.style.display='flex';
      resultScore.textContent=`${correctCount} / 10`;
      if(correctCount===10){
        resultTitle.textContent='おめでとう！';
        resultText.textContent='君は牛タン倶楽部入り！';
        playSound('ome');
      } else {
        resultTitle.textContent='結果発表';
        resultText.textContent='';
      }
    }

    document.getElementById('toTitleBtn').addEventListener('click',()=>{
      resultScreen.style.display='none';
      titleScreen.style.display='flex';
    });

    function playSound(name){
      try{
        const s=SOUNDS[name];
        if(!s)return;
        s.currentTime=0;
        s.play().catch(()=>{});
      }catch(e){}
    }

    // プリロード処理
    (function preload(){
      const imgs=[];
      ['player.png','player2.png','player3.png','hiko.png','hiko2.png','hiko3.png']
        .concat(ICONS.map(i=>i.src))
        .forEach(src=>{
          const i=new Image();
          i.src=src;
          imgs.push(i);
        });
    })();
  </script>
</body>
</html>
